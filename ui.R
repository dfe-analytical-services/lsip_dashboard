fluidPage(
  shinyjs::useShinyjs(),
  includeCSS("www/dfe_shiny_gov_style.css"),
  title = "Unit for Future Skills - Local Skills Dashboard",
  # use_tota11y(), # accessibility layer for local testing

  # Set metadata for browser ==================================================

  tags$html(lang = "en"),
  # meta_general(
  #   application_name = "DfE Analytical Services R-Shiny Template",
  #   description = "R-Shiny template for use by DfE external data dashboards",
  #   robots = "index,follow",
  #   generator = "R-Shiny",
  #   subject = "Education data dashboards",
  #   rating = "General",
  #   referrer = "no-referrer"
  # ),

  # Set title for search engines
  HTML("<title>Local Skills Dashboard</title>"),
  tagList(
    tags$head(tags$style(HTML("
                           .navbar-nav {
                           float: none !important;
                           }
                           .navbar-nav > li:nth-child(4) {
                           float: right;
                           }
                           ")))
  ),
  tags$head(includeHTML(("google-analytics.html"))),

  # Navbar ====================================================================
  navbarPage(
    id = "navbar",
    title = "",
    collapsible = TRUE,

    # HOMEPAGE ============================================================

    tabPanel(
      "Homepage",
      fluidPage(
        fluidRow(column(
          width = 12,
          style = "background-color:#6a282a;color: #FFFFFF;font-size: 16px",
          "Please be aware that you may experience performance issues and the dashboard may require a reload. We are working to fix this.",
        )),
        fluidRow(
          column(
            12,
            h1("Local Skills Dashboard"),
            p("Prototype dashboard showing statistics on local employment and skills in England, to support local skills planning and delivery (including Local Skills Improvement Plans)."),
            p("The prototype dashboard shows a subset of employment and skills statistics at Local Enterprise Partnership (LEP) or local skills improvement plan area (LSIP) level, including:"),
            tags$ul(
              tags$li("Employment rates and employment distribution by occupation (source: ONS Annual Population Survey), ILR and ONS online job vacancies)"),
              tags$li("Online job vacancy units (source: ONS Online Job Adverts)"),
              tags$li("Further Education aim achievement volumes and achievements by sector subject area (source: DfE FE and Skills National Statistics)"),
            ),
            p("Trends can be compared between different LEPs/LSIPs and over time for some indicators. The underlying data contains national, regional, LEP, LSIP and LA data and can be downloaded directly from the dashboard."),
            br(),
            "This dashboard has been produced to support the aims of the ",
            a(
              href = "https://www.gov.uk/government/groups/unit-for-future-skills",
              "Unit for Future Skills",
              .noWS = c("after")
            ),
            ".",
            box(
              width = 12,
              p(" ")
            )
          ),

          ## Left panel -------------------------------------------------------
          column(
            6,
            # div(
            div(
              class = "panel panel-info",
              div(
                class = "panel-heading",
                style = "color: white;font-size: 18px;font-style: bold; background-color: #1d70b8;",
                h2("Contents")
              ),
              div(
                class = "panel-body",
                h2("Dashboard"),
                p("This page contains the different dashboard tabs."),
                h3(actionLink("link_to_tabpanel_overview", "Overview")),
                p("This tab provides a summary of employment and skills metrics at LEP or LSIP level. It displays employment volume, employment rate, proportion of online vacancies, Further Education (FE) and skills achievement volumes. It shows year-on-year change for each indicator."),
                p("The download buttons download all indicators for the selected LEP/LSIP or for all available geographies (England, region, LEP, LSIP, LA)."),
                # h2("Labour market"),
                h3(actionLink("link_to_tabpanel_employment", "Employment")),
                p("This tab contains employment indicators at LEP or LSIP level. These can be compared to England and a comparator LEP/LSIP."),
                p("The line chart shows employment rate over time for the chosen LEP/LSIP. The table displays employment distribution by occupation (sub-major SOC group)."),
                p("The download buttons download employment indicators for the selected LEP/LSIP or for all available geographies (England, region, LEP, LSIP, LA)."),
                h3(actionLink("link_to_tabpanel_vacancies", "Vacancies")),
                p("This tab contains online job vacancies indicators at LEP or LSIP level. These can be compared to England and a comparator LEP/LSIP."),
                p("The line chart shows change in online job vacancy units over time. Units are not real volumes but represent a fixed number of job adverts to be used for comparisons over time and between areas."),
                p("The download buttons download vacancy indicators for the selected LEP/LSIP or for all available geographies (England, region, LEP, LSIP, LA)."),
                # h2("Skills landscape"),
                h3(actionLink("link_to_tabpanel_FE", "Skills")),
                p("This tab provides a summary of further education (FE) and skills statistics at LEP or LSIP level. These can be compared to another LEP/LSIP."),
                p("The line chart shows achievement volumes over time for apprenticeships, education & training and community learning."),
                p("The bar chart displays distribution of FE and skills achievements by SSA for the latest available period."),
                p("The download buttons download FE and skills indicators for the selected LEP/LSIP or for all available geographies (England, region, LEP, LSIP, LA)."),
              )
            )
          ), # end of left panel

          ## Right panel ------------------------------------------------------
          column(
            6,
            div(
              div(
                class = "panel panel-info",
                div(
                  class = "panel-heading",
                  style = "color: white;font-size: 18px;font-style: bold; background-color: #1d70b8;",
                  h2("Data sources")
                ),
                div(
                  class = "panel-body",
                  h2("Labour market"),
                  h3("Annual Population Survey (APS)"),
                  p("A continuous household survey covering the UK.
                             The dashboard uses employment volumes and rates for each LEP or LSIP and split by sub-major SOC 2010 grouping.
                             The data are for interviews conducted over the calendar year (2017-2021 are shown).
                             "),
                  a(
                    href = "https://www.nomisweb.co.uk/datasets/apsnew",
                    "APS data on Nomis",
                    .noWS = c("after")
                  ),
                  br(),
                  h3("ONS Online Job Adverts"),
                  p("These data tables are created based upon online job adverts data provided by Adzuna.
                             Each time point in the series covers a monthly average of the volume of online job adverts in the month of January for the years 2017 to 2022. The monthly average is derived from weekly snapshots in January.
                             The dashboard shows job 'units' which is the number of job adverts divided a by set value for all regions. It is therefore not an indication of the real volume of job adverts, but can be used in comparisons across regions or to follow trends over time."),
                  a(
                    href = "https://www.ons.gov.uk/employmentandlabourmarket/peopleinwork/employmentandemployeetypes/datasets/onlinejobadvertsbyitl1regionandlocalauthority",
                    "Job adverts data on ONS",
                    .noWS = c("after")
                  ),
                  br(),
                  h2("Skills landscape"),
                  h3("Individualised Learner Records (ILR)"),
                  p("The ILR is an on-going collection of data about learners from training providers in the Further Education (FE) and Skills sector in England.
                             The dashboard uses FE and skills learner achievements over time (AY1617-21/22 (provisional data to January for 21/22)) split by apprenticeships, community learning, education and training.
                             The data is taken from the FE and Skills official statistics."),
                  a(
                    href = "https://explore-education-statistics.service.gov.uk/find-statistics/further-education-and-skills",
                    "ILR data on EES",
                    .noWS = c("after", "before")
                  )
                )
              )
            ),
            div(
              class = "panel panel-info",
              div(
                class = "panel-heading",
                style = "color: white;font-size: 18px;font-style: bold; background-color: #1d70b8;",
                h2("Version control")
              ),
              div(
                class = "panel-body",
                p("Version 0.1. August 2022."),
                h3("Future development"),
                p("This dashboard will be developed with additional data and features in consultation with users. An updated dashboard will be released in Autumn 2022. This will include:"),
                tags$ul(
                  tags$li("A wider range of statistics on employment and skills;"),
                  tags$li("Additional data breakdowns;"),
                  tags$li("New features, including the ability to view data at different geography levels (e.g. Local Authority District)."),
                ),
                "If you have any feedback or suggestions for improvement, please contact us at ",
                a(href = "mailto:ufs.contact@education.gov.uk", "ufs.contact@education.gov.uk", .noWS = c("after")), "."
              )
            )
          ), # end of right panel
        ) # end of FluidRow
      ) # end of FluidPage
    ), # end of Tab Panel

    # APP ----

    tabPanel(
      "Dashboard",
      fluidRow(column(
        width = 12,
        style = "background-color:#6a282a;color: #FFFFFF;font-size: 16px",
        "Please be aware that you may experience performance issues and the dashboard may require a reload. We are working to fix this.",
      )),
      box(
        width = 12,
        p(" ")
      ),
      # choice row
      sidebarLayout(
        sidebarPanel(
          width = 2,
          radioButtons("GeoType",
            label = "Choose geography level:",
            choices = list("LEP", "LSIP"),
            selected = "LEP"
          ),
          uiOutput("lep1_geo"),
          uiOutput("lep2_off")
        ),

        # next row is the data tabs
        mainPanel(
          width = 10,
          tabsetPanel(
            id = "datatabset",

            # OVERVIEW ----
            tabPanel(
              "Overview",
              ## Main panel ----
              box(
                width = 12,
                uiOutput("page0title", style = "font-size: 24px;"),
                div("Change metrics are measured since the same period the year before.", style = "font-size: 16px; font-style: italic;"),
                br(),
                fluidRow(
                  # left column
                  column(
                    width = 5,
                    style = "background-color:#f3f2f1;",
                    h2("Labour market"),
                    h3("People employed"),
                    fluidRow(
                      column(
                        width = 4,
                        div(
                          title = "Source: APS. 2021 calendar year",
                          uiOutput("locland.emplcnt0"),
                        )
                      ),
                      column(
                        width = 7,
                        plotlyOutput("empLineChart", height = 81)
                      )
                    ),
                    h3("Employment rate"),
                    fluidRow(
                      column(
                        width = 4,
                        div(
                          title = "Source: APS. 2021 calendar year",
                          uiOutput("locland.emplrate0"),
                        )
                      ),
                      column(
                        width = 7,
                        plotlyOutput("empRateLineChart", height = 81)
                      )
                    ),
                    # third row - link to emp tab
                    box(
                      width = 12,
                      actionLink("link_to_tabpanel_employment2", "Find out more about employment"),
                      align = "right"
                    ),
                    box(
                      width = 12,
                      p(" ")
                    ),
                    # fourth row - vacancies
                    h3("Job vacancy share"),
                    fluidRow(
                      column(
                        width = 4,
                        div(
                          title = "Source: ONS (Adzuna). Jan 2022. Share of job vacancies in England.",
                          uiOutput("jobad.units"),
                        )
                      ),
                      column(
                        width = 7,
                        plotlyOutput("VacLineChart", height = 81)
                      )
                    ),
                    box(
                      width = 12,
                      actionLink("link_to_tabpanel_vacancies2", "Find out more about vacancies"),
                      align = "right"
                    )
                  ),
                  column(width = 1), # column split
                  # right column
                  column(
                    width = 5,
                    style = "background-color:#f3f2f1;",
                    h2("Skills landscape"),
                    h3("Education and training achievements"),
                    fluidRow(
                      column(
                        width = 4,
                        div(
                          title = "Source: ILR AY20/21",
                          uiOutput("skisup.ETach"),
                        )
                      ),
                      column(
                        width = 7,
                        plotlyOutput("etLineChart", height = 81)
                      )
                    ),
                    h3("Apprenticeship achievements"),
                    fluidRow(
                      column(
                        width = 4,
                        div(
                          title = "Source: ILR AY20/21",
                          uiOutput("skisup.APPach"),
                        )
                      ),
                      column(
                        width = 7,
                        plotlyOutput("AppLineChart", height = 81)
                      )
                    ),
                    # 6th row - link to app data
                    box(
                      width = 12,
                      actionLink("link_to_tabpanel_FE2", "Find out more about skills"),
                      align = "right"
                    ),
                  ) # end of right column
                ), # end of data row
                ### Downloads-------------
                br(),
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn0a",
                      label = "All data   ",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(
                    width = 9,
                    "Download all available indicators for all geographies (LEPs, LSIPs, LAs, regions and England)",
                  )
                ),
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn0b",
                      label = "Current LEP/LSIP",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(width = 9, "Or just for the currently chosen LEP/LSIP")
                ),
                box(
                  width = 12,
                  p(" ")
                )
              ) # end of main pane box
            ), # end of Overview tab

            # EMPLOYMENT  ----
            tabPanel(
              "Employment",
              ## Main panel ----
              box(
                width = 12,
                uiOutput("page1title", style = "font-size: 24px;"),
                div("Data is from the Annual Population Survey. Years represent calendar years. All figures are for 16-64 except the occupation split table which is all ages.", style = "font-size: 16px; font-style: italic;"),
                br(),

                ### KPI boxes ----
                box(
                  width = 12,
                  valueBoxOutput("locland.emplcnt"),
                  valueBoxOutput("locland.emplrate")
                ),
                box(
                  width = 12,
                  uiOutput("emp_comp")
                ),
                box(
                  width = 12,
                  p(" ")
                ),
                ### Employment rate over time line chart ----
                column(
                  width = 6,
                  p("Employment rate trend", style = "font-size:20px;"),
                  plotlyOutput("EmpRate_time")
                ),
                ### Employment percentage by occupation data table ----
                column(
                  width = 6,
                  p("Employment percentage by occupation (sub-major SOC group)", style = "font-size:20px;"),
                  dataTableOutput("EmpOcc")
                ),
                # br(),
                # column(
                #   width = 12,
                #   p("Employment rates", style = "font-size:20px;"),
                #   plotlyOutput("EmpRate_dot")
                # ),

                ### Downloads-------------
                box(
                  width = 12,
                  p(" ")
                ),
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn1a",
                      label = "All data   ",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(
                    width = 9,
                    "Download employment indicators for all geographies (LEPs, LSIPs, LAs, regions and England)",
                  )
                ), # end of row
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn1b",
                      label = "Current LEP/LSIP",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(width = 9, p("Or just for the currently chosen LEP/LSIP")),
                  box(
                    width = 12,
                    p(" ")
                  )
                ) # end of row
              ) # end of main panel
            ), # end of Local Landscape tab

            # VACANCIES ---------------
            tabPanel(
              "Vacancies",
              ## Main panel ----
              box(
                width = 12,
                uiOutput("page3title", style = "font-size: 24px;"),
                div("Data is from ONS using Adzuna online job adverts. Data for each year is the average of vacancies across January of that year.", style = "font-size: 16px; font-style: italic;"),
                br(),
                ### KPI boxes ----
                box(
                  width = 12,
                  valueBoxOutput("jobad.pc"),
                  valueBoxOutput("jobad.ch"),
                ), # end of box
                box(
                  width = 12,
                  uiOutput("vac_comp")
                ),
                box(
                  width = 12,
                  p(" ")
                ),
                box(
                  width = 12,
                  ### Online job vacancy units over time line chart ----
                  column(
                    width = 12,
                    p("Online job vacancy unit trend", style = "font-size:20px;"),
                    plotlyOutput("jobad.time")
                  ),
                ), # end of box
                details(
                  inputId = "SubsLev",
                  label = "Chart information",
                  help_text = "Each time point in the series covers a monthly average of the volume of online job adverts in the month of January for the years 2017 to 2022.
              The monthly average is derived from weekly snapshots in January. The volume of online job adverts is presented as a standardised unit measure. The unit measure is derived by dividing the actual monthly average count of job adverts by a single set value. The job vacancy units can therefore be used to compare between LEPs/LSIPs and over time, but do not represent true job vacancy volumes."
                ),
                ### Downloads-------------
                br(),
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn3a",
                      label = "All data   ",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(
                    width = 9,
                    "Download vacancy indicators for all geographies (LEPs, LSIPs, LAs, regions and England)",
                  )
                ), # end of row
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn3b",
                      label = "Current LEP/LSIP",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(width = 9, p("Or just for the currently chosen LEP/LSIP")),
                  box(
                    width = 12,
                    p(" ")
                  )
                ) # end of row
              ) # end of main panel
            ), # end of Skills Supply tab
            # FE ----
            tabPanel(
              "Skills",
              # Main panel
              box(
                width = 12,
                uiOutput("page2title", style = "font-size: 24px;"),
                div("Data from Individualised Learner Records for FE and skills learners. Years shown are academic years.", style = "font-size: 16px; font-style: italic;"),
                br(),
                ### KPI boxes ----
                box(
                  width = 12,
                  valueBoxOutput("skisup.FEach"),
                  valueBoxOutput("skisup.APach"),
                ),
                box(
                  width = 12,
                  uiOutput("skill_comp")
                ),
                box(
                  width = 12,
                  p(" ")
                ),
                box(
                  width = 12,
                  ### Achievements over time line chart ----
                  column(
                    width = 6,
                    p("FE and skills learner achievement trend", style = "font-size:20px;"),
                    p("Choose provision group:"),
                    selectizeInput("skill_line", NULL,
                      choices = c("Apprenticeships (all ages)", "Education and training (adults only)", "Community learning (adults only)", "Total FE and skills provision")
                    ),
                    plotlyOutput("Ach_time"),
                    p("Total achievements are the count of learners that achieved at any point during the stated academic period. Learners achieving more than one course will appear only once in the grand total.", style = "font-style: italic;")
                  ),
                  ### FE achievements by SSA----
                  column(
                    width = 6,
                    p("All FE and skills learner achievements by SSA tier 1 (AY21/22 Aug to Jan provisional data)", style = "font-size:20px;"),
                    plotlyOutput("Ach_SSA_pc")
                  )
                ), # end of charts box
                ### FE definitions----
                details(
                  inputId = "FEdefs",
                  label = "FE definitions",
                  tags$ul(
                    tags$li("FE and skills include all age apprenticeships and wider adult (19+) FE learning, such as community learning and education and training."),
                    tags$li("Further Education covers publicly-funded learning delivered by an FE institution, a training provider or within a local community. It also includes apprenticeships delivered in the workplace. It does not include higher education, unless delivered as part of an apprenticeship programme."),
                    tags$li("Apprenticeships are paid jobs that incorporate on-the-job and off-the-job training leading to nationally recognised qualifications."),
                    tags$li("Community learning funds a wide range of non-formal courses (e.g. IT or employability skills) and activity targeted at deprived areas or disadvantaged groups. They can be offered by local authorities, colleges, community groups."),
                    tags$li("Education and training is mainly classroom-based adult FE that is not an apprenticeship or community learning."),
                    tags$li("Achievements are the number of learners who successfully complete an individual aim in an academic year. "),
                  )
                ),
                ### Downloads-------------
                box(
                  width = 12,
                  p(" ")
                ),
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn2a",
                      label = "All data   ",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(
                    width = 9,
                    "Download FE and skills indicators for all geographies (LEPs, LSIPs, LAs, regions and England)",
                  )
                ), # end of row
                fluidRow(
                  column(
                    width = 3,
                    downloadButton(
                      outputId = "download_btn2b",
                      label = "Current LEP/LSIP",
                      icon = shiny::icon("download"),
                      class = "downloadButton"
                    )
                  ),
                  column(width = 9, p("Or just for the currently chosen LEP/LSIP")),
                  box(
                    width = 12,
                    p(" ")
                  )
                ) # end of row
              ) # end of main panel
            ) # sills panel
          ) # end of dashboard tabset panel
        ) # end of dashboard navbar
      ) # end of app data row
    ), # end of app tab panel

    # Create the accessibility statement-----------------
    tabPanel(
      "Accessibility",
      fluidRow(column(
        width = 12,
        style = "background-color:#6a282a;color: #FFFFFF;font-size: 16px",
        "Please be aware that you may experience performance issues and the dashboard may require a reload. We are working to fix this.",
      )),
      box(
        width = 12,
        p(" ")
      ),
      h2("Accessibility statement"),
      br("This accessibility statement applies to the Local Skills dashboard.
            This dashboard is run by the Department for Education. We want as many people as possible to be able to use this application,
            and have actively developed this dashboard with accessibilty in mind."),
      h3("WCAG 2.1 compliance"),
      br("We follow the reccomendations of the ", a(href = "https://www.w3.org/TR/WCAG21/", "WCAG 2.1 requirements. "), "This application has been checked using the ", a(href = "https://github.com/ewenme/shinya11y", "Shinya11y tool "), ", which did not detect accessibility issues.
             This dashboard also fully passes the accessibility audits checked by the ", a(href = "https://developers.google.com/web/tools/lighthouse", "Google Developer Lighthouse tool"), ". This means that this dashboard:"),
      tags$div(tags$ul(
        tags$li("uses colours that have sufficient contrast"),
        tags$li("allows you to zoom in up to 300% without the text spilling off the screen"),
        tags$li("has its performance regularly monitored, with a team working on any feedback to improve accessibility for all users")
      )),
      h3("Limitations"),
      br("We recognise that there are still potential issues with accessibility in this dashboard, but we will continue
             to review updates to technology available to us to keep improving accessibility for all of our users. For example, these
            are known issues that we will continue to monitor and improve:"),
      tags$div(tags$ul(
        tags$li("Keyboard navigation through the interactive charts is currently limited, and some features are unavailable for keyboard only users"),
        tags$li("Alternative text in interactive charts is limited to titles and could be more descriptive (although this data is available in csv format)")
      )),
      h3("Feedback"),
      br(
        "If you have any feedback on how we could further improve the accessibility of this dashboard, please contact us at",
        a(href = "mailto:statistics.development@education.gov.uk", "statistics.development@education.gov.uk")
      ),
      br()
    ), # End of accessibility tab
    # Support links ===========================================================

    tabPanel(
      "Support and feedback",
      fluidRow(column(
        width = 12,
        style = "background-color:#6a282a;color: #FFFFFF;font-size: 16px",
        "Please be aware that you may experience performance issues and the dashboard may require a reload. We are working to fix this.",
      )),
      box(
        width = 12,
        p(" ")
      ),
      support_links() # defined in R/supporting_links.R
    )
  ), # End of navBarPage
  # Footer ====================================================================

  shinyGovstyle::footer(TRUE)
)

